"use strict";var r=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var P=(t,e)=>{for(var n in e)r(t,n,{get:e[n],enumerable:!0})},I=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of K(e))!g.call(t,o)&&o!==n&&r(t,o,{get:()=>e[o],enumerable:!(i=S(e,o))||i.enumerable});return t};var A=t=>I(r({},"__esModule",{value:!0}),t);var N={};P(N,{handler:()=>k});module.exports=A(N);var s=require("@aws-sdk/client-kms"),c=new s.KMS({}),R={READ:["kms:Decrypt"],WRITE:["kms:Encrypt","kms:GenerateDataKey*"]};async function k(t){if(t.RequestType==="Create"||t.RequestType==="Update"){let e=t.ResourceProperties,n=e.DistributionId,i=e.KmsKeyId,o=e.AccountId,a=e.Partition,u=process.env.AWS_REGION,m=e.AccessLevels;if((await c.describeKey({KeyId:i})).KeyMetadata?.KeyManager===s.KeyManagerType.AWS)return;let y=await c.getKeyPolicy({KeyId:i,PolicyName:"default"});if(!y.Policy)throw new Error("An error occurred while retrieving the key policy.");let d=JSON.parse(y?.Policy);console.log("Retrieved key policy",JSON.stringify(d,void 0,2));let p=w(m),f={Sid:"AllowCloudFrontServicePrincipalSSE-KMS",Effect:"Allow",Principal:{Service:["cloudfront.amazonaws.com"]},Action:p,Resource:`arn:${a}:kms:${u}:${o}:key/${i}`,Condition:{StringEquals:{"AWS:SourceArn":`arn:${a}:cloudfront::${o}:distribution/${n}`}}},l=C(d,f);return console.log("Updated key policy",JSON.stringify(l,void 0,2)),await c.putKeyPolicy({KeyId:i,Policy:JSON.stringify(l),PolicyName:"default"}),{IsComplete:!0}}else return}function w(t){let e=[];for(let n of t)e=e.concat(R[n]);return e}function C(t,e){return E(t,e)||t.Statement.push(e),t}function E(t,e){return t.Statement.some(n=>JSON.stringify(n)===JSON.stringify(e))}0&&(module.exports={handler});
